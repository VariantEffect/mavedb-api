name: Run Tests
on:
  push:
    # Run all tests on main, fast tests on other branches

env:
  LOG_CONFIG: test

jobs:
  run-mypy-3_11:
    runs-on: ubuntu-latest
    name: MyPy checks on Python 3.11
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    - run: sudo apt-get update
    - run: sudo apt-get install -y tabix
    - run: pip install --upgrade pip
    - run: pip install poetry
    - run: poetry install --with dev --extras server
    - run: poetry run mypy src/

  run-ruff-lint:
    runs-on: ubuntu-latest
    name: Ruff linting on Python 3.11
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    - run: sudo apt-get update
    - run: sudo apt-get install -y tabix
    - run: pip install --upgrade pip
    - run: pip install poetry
    - run: poetry install --with dev --extras server
    - run: poetry run ruff check

  run-tests-3_11-core-dependencies:
    runs-on: ubuntu-latest
    name: Pytest on Core Dependencies-- Python 3.11
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    - run: pip install --upgrade pip
    - run: pip install poetry
    - run: poetry install --with dev
    - name: Run fast tests on non-main branches
      if: github.event_name == 'push' && github.ref != 'refs/heads/main'
      run: poetry run pytest tests/ -m "not network and not slow"
    - name: Run full tests on main
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: poetry run pytest tests/

  run-tests-3_11:
    runs-on: ubuntu-latest
    name: Pytest on Optional Dependencies-- Python 3.11
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    - run: sudo apt-get update
    - run: sudo apt-get install -y tabix
    - run: pip install --upgrade pip
    - run: pip install poetry
    - run: poetry install --with dev --extras server
    - name: Run fast tests on non-main branches
      if: github.ref != 'refs/heads/main'
      run: poetry run pytest tests/ -m "not network and not slow" --show-capture=stdout
    - name: Run all tests with coverage on main branch
      if: github.ref == 'refs/heads/main'
      run: poetry run pytest tests/ --show-capture=stdout --cov=src

  run-tests-3_12-core-dependencies:
    runs-on: ubuntu-latest
    name: Pytest on Core Dependencies-- Python 3.12
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'
    - run: pip install --upgrade pip
    - run: pip install poetry
    - run: poetry install --with dev
    - name: Run fast tests on non-main branches
      if: github.ref != 'refs/heads/main'
      run: poetry run pytest tests/ -m "not network and not slow"
    - name: Run all tests on main branch
      if: github.ref == 'refs/heads/main'
      run: poetry run pytest tests/

  run-tests-3_12:
    runs-on: ubuntu-latest
    name: Pytest on Optional Dependencies-- Python 3.12
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'
    - run: sudo apt-get update
    - run: sudo apt-get install -y tabix
    - run: pip install --upgrade pip
    - run: pip install poetry
    - run: poetry install --with dev --extras server
    - name: Run fast tests on non-main branches
      if: github.ref != 'refs/heads/main'
      run: poetry run pytest tests/ -m "not network and not slow" --show-capture=stdout
    - name: Run all tests with coverage on main branch
      if: github.ref == 'refs/heads/main'
      run: poetry run pytest tests/ --show-capture=stdout --cov=src
